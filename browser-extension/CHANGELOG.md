# 更新日志

## v1.6.4 - 2025-11-16

### 🔥 修复：增加嵌套列表缩进以适配 Kelivo

- **问题**：Kelivo 无法正确识别嵌套列表，因为缩进空格太少
- **用户反馈**："空格太少了，导致在 kelivo 里没有显示出来"
- **🔥 解决方案**：增加嵌套列表的缩进空格数量
  - 第一级列表：无缩进
  - 第二级列表：5 个空格缩进
  - 第三级及以上：每级增加 2 个空格
  - 使用 `*` 作为无序列表标记（与 Kelivo 示例一致）
- **修复前**（4 个空格）：
  ```markdown
  - 项目 1
      - 子项目 1
      - 子项目 2
  ```
- **修复后**（5+ 个空格）：
  ```markdown
  * 项目 1
       * 子项目 1
       * 子项目 2
  ```
- **参考**：根据用户提供的 Kelivo 格式示例调整

## v1.6.3 - 2025-11-16

### 修复：嵌套列表缩进问题（第一次尝试）

- **问题**：嵌套列表的缩进不正确
- **尝试**：使用 4 个空格作为缩进单位
- **结果**：空格太少，Kelivo 无法识别

## v1.6.2 - 2025-11-16

### 🔥 重大修复：从 HTML 转换为 Markdown

- **问题**：复制按钮复制的纯文本没有 Markdown 格式标记
- **用户反馈**："我点击复制按钮，复制进入 Obsidian 和 Notion 和 Typora 都是标准的 md 格式"
- **发现**：复制按钮同时复制了 HTML 格式，Obsidian/Notion/Typora 会自动将 HTML 转换为 Markdown
- **🔥 解决方案**：从复制事件中获取 HTML 格式，然后转换为 Markdown
  - 监听 `copy` 事件
  - 获取 `e.clipboardData.getData('text/html')`
  - 使用现有的 `htmlToMarkdown()` 函数转换
  - 保留所有格式（粗体、斜体、代码块、列表、链接等）
- **优势**：
  - ✅ 获取完整的 Markdown 格式
  - ✅ 支持所有格式标记
  - ✅ 与 Obsidian/Notion/Typora 的行为一致
  - ✅ 不依赖 DOM 提取

## v1.6.1 - 2025-11-16

### 修复：处理 Markdown 引用与角色标记冲突

- **问题**：导出的 Markdown 中，引用 `> text` 与角色标记 `> 用户` / `> 助手` 冲突
- **解决方案**：将消息内容中的 Markdown 引用转换为缩进格式（4 个空格）

## v1.6.0 - 2025-11-16

### 🔥 最终方案：只使用复制按钮获取 Markdown 格式

- **用户反馈**：DOM 提取方法仍然有内容缺失
- **用户要求**：只使用复制按钮方法，因为复制按钮能获取完整内容
- **🔥 最终解决方案**：只保留复制按钮方法
  - 移除所有 DOM 提取的回退逻辑
  - 只通过复制按钮获取内容
  - ChatGPT 的复制按钮会复制 Markdown 格式的内容
  - 直接使用复制的 Markdown 内容
- **工作流程**：
  1. 找到所有消息元素
  2. 触发鼠标悬停事件，显示复制按钮
  3. 在消息元素及其父元素中查找复制按钮
  4. 模拟点击复制按钮
  5. 监听 `copy` 事件，拦截剪贴板内容
  6. 获取 Markdown 格式的内容
- **优势**：
  - ✅ 获取 100% 完整的内容（复制按钮本身就能获取完整内容）
  - ✅ 保留完整的 Markdown 格式
  - ✅ 速度快（每条消息约 0.5 秒）
  - ✅ 不依赖 DOM 结构
  - ✅ 不需要滚动
  - ✅ 符合 Kelivo 的导入格式
- **时间成本**：
  - 8 条消息：约 4 秒
  - 50 条消息：约 25 秒
  - 100 条消息：约 50 秒
- **注意事项**：
  - 需要确保复制按钮可见（通过触发鼠标悬停事件）
  - 如果找不到复制按钮，该消息会被跳过
  - 需要 `clipboardRead` 和 `clipboardWrite` 权限

## v1.5.0 - 2025-11-16

### 尝试改进 DOM 提取（已放弃）

- **尝试**：改进滚动逻辑，逐个滚动到每条消息
- **问题**：仍然有内容缺失
- **结论**：DOM 提取方法不可靠，放弃

## v1.4.0 - 2025-11-16

### 尝试通过复制按钮获取内容（已放弃）

- **尝试**：模拟点击复制按钮获取内容
- **问题**：复制按钮只能获取纯文本，无法保留 Markdown 格式
- **结论**：不适合我们的需求，回退到 DOM 提取方法

## v1.3.0 - 2025-11-16

### 🔥 尝试使用 ChatGPT API（失败）

- **尝试**：直接调用 ChatGPT 的内部 API 获取完整对话数据
- **结果**：API 返回 404，可能已被禁用或需要特殊认证
- **教训**：API 方法虽然理想，但不可靠

## v1.2.0 - 2025-11-16

### 🎉 重大改进：完善导出格式

### 🐛 重要修复

- **修复消息数量错误的问题** ⭐ 关键修复
  - 问题：引用块（blockquote）中的 `>` 被误认为角色标记，导致一条消息被拆分成多条
  - 示例：8 条消息被错误拆分成 32 条
  - 解决：将 blockquote 改用 `**引用：**` 标记，避免与 Kelivo 的角色标记冲突
  - 现在消息数量正确，不会出现异常拆分

- **🔥 使用 scrollIntoView 方法彻底解决内容加载问题** ⭐ 重要改进
  - 问题：之前的滚动方法（scrollTo/scrollTop）在 ChatGPT 上不生效，滚动位置一直是 0
  - 根本原因：ChatGPT 使用虚拟滚动（Virtual Scrolling），只渲染可见区域的内容
  - 🔥 新方法：使用 `scrollIntoView` 逐个滚动到每条消息
  - 解决方案：
    1. **找到所有消息元素**：使用 `[data-message-author-role]` 选择器
    2. **滚动到最后一条消息**：触发加载更多内容
    3. **从后往前滚动**：确保每条消息都被渲染到 DOM 中
    4. **每条消息等待 300ms**：确保内容完全渲染
    5. **改用 for 循环**：支持 async/await，每条消息提取前等待 300ms
    6. 提取每条消息前：滚动到该消息位置，等待 300ms 让内容渲染
  - 优势：
    - ✅ `scrollIntoView` 是浏览器原生方法，兼容性好
    - ✅ 直接操作 DOM 元素，不依赖容器选择
    - ✅ 确保每条消息都在视口中停留足够时间
  - 改进：重写 `processListItems` 函数，更准确地处理列表项和嵌套内容
  - 添加详细的调试日志，帮助定位问题
  - 现在可以获取完整的对话内容，不会遗漏任何信息
  - ⚠️ 注意：使用超慢速滚动确保内容完整
    - 8 条消息：约 23 秒
    - 50 条消息：约 2 分钟
    - 100 条消息：约 3.75 分钟
  - 🔥 最新优化：进一步增加等待时间（根据用户反馈）
    - 滚动到最后一条消息：等待 **5 秒**（之前 3 秒）
    - 从后往前滚动：每条消息等待 **1200ms（1.2秒）**（之前 800ms）
    - 提取消息时：每条消息等待 **1000ms（1秒）**（之前 600ms）
    - 使用 `behavior: 'smooth'` 而不是 `'auto'`，滚动更慢更稳定
  - 💡 设计理念：宁可慢一点，也要确保内容完整！

#### 新增功能
- ✅ **HTML 转 Markdown**：完整保留原始格式
  - 支持粗体（`**text**`）、斜体（`*text*`）、行内代码（`` `code` ``）
  - 支持代码块（带语言标识）
  - 支持列表（有序和无序，包括嵌套）
  - 支持标题（H1-H6）
  - 支持引用块（blockquote）
  - 支持表格
  - 支持链接和图片
  - 支持水平分隔线

- ✅ **改进的输出格式**：
  - 使用 `> 用户` 和 `> 助手` 标记角色（符合 Kelivo 导入格式要求）
  - AI 回复和用户提问明显分开，易于阅读
  - 保留完整的 Markdown 格式结构
  - 自动清理多余空行
  - 智能移除按钮和工具栏等噪音元素
  - 导入到 Kelivo 后格式不会乱

#### 格式对比

**旧格式（v1.1.1 及之前）：**
```markdown
> user:
这是用户消息（纯文本，无格式）

> assistant:
这是助手回复（纯文本，无格式）
```

**新格式（v1.2.0）：**
```markdown
> 用户

这是用户消息

> 助手

这是助手回复，支持：

- **粗体文本**
- *斜体文本*
- `行内代码`

### 子标题

```python
def hello():
    print("Hello, World!")
```

• 列表项 1
• 列表项 2

> 用户

下一条消息...
```

**格式说明：**
- ✅ 使用 `> 用户` 和 `> 助手` 标记（符合 Kelivo 导入格式）
- ✅ 保留完整的 Markdown 格式（粗体、列表、代码块等）
- ✅ 导入到 Kelivo 后显示正常，不会格式混乱

#### 技术改进
- 使用 DOM 遍历和转换，而不是简单的 `innerText` 提取
- 智能识别 HTML 元素并转换为对应的 Markdown 语法
- 保留嵌套结构（如列表中的列表、引用中的格式）
- 自动提取代码块的语言标识（从 `class="language-xxx"` 中提取）
- 递归处理复杂的 HTML 结构

#### 解决的问题
- ❌ **旧版问题**：使用 `innerText` 导致所有格式丢失（粗体、列表、代码块等）
- ✅ **新版解决**：完整保留 ChatGPT 的格式，导出后在 Kelivo 中显示效果与原始对话一致

---

## v1.1.1 - 2025-11-16

### ✨ 新功能

- **服务器状态检测**
  - 点击导出前自动检测 `kelivo_import_server.exe` 是否运行
  - 如果服务器未运行，显示友好的提示对话框
  - 提供清晰的操作步骤指导用户启动服务器
  - 避免用户等待后才发现服务器未启动的问题

### 🐛 问题修复

- **修复服务器检测无法访问 localhost 的问题** ⭐ 重要修复
  - 添加 `http://localhost:*/*` 和 `http://127.0.0.1:*/*` 到 host_permissions
  - 修复扩展无法访问本地服务器导致检测失败的问题
  - 现在可以正确检测服务器状态

- **修复助手名称无法修改的问题**
  - 移除了自动迁移逻辑，不再强制将"意图"改为"默认助手"
  - 用户现在可以自由修改助手名称为任意值

- **修复默认值不一致的问题**
  - 统一 `popup.js` 和 `background.js` 中的默认助手名称为"默认助手"
  - 确保首次安装和运行时的默认值一致

### 🔧 技术改进

- 简化 `loadConfig()` 函数，移除不必要的自动迁移代码
- 统一所有文件中的默认配置值
- 新增 `checkServerStatus()` 函数用于服务器健康检查
- 新增 `showServerNotRunningDialog()` 对话框组件
- 智能服务器检测：优先使用 `/health` 端点，如果不存在则使用 `/import` OPTIONS 请求
- 优化超时时间：2秒快速检测，提升用户体验

### 📝 注意事项

**兼容性**：此版本兼容新旧服务器
- ✅ 如果服务器支持 `/health` 端点，使用健康检查（推荐）
- ✅ 如果服务器不支持 `/health` 端点，使用 OPTIONS 请求检测
- ✅ 无需立即更新服务器，扩展可以正常工作

**建议**：为了更好的性能，建议服务器添加 `/health` 端点，参考 `服务器健康检查端点说明.md`。

## v1.1.0 - 2025-11-16

### ✨ 新功能

- **完整对话导出**：自动滚动页面确保长对话完整导出
  - 自动检测页面滚动高度
  - 分段滚动触发 ChatGPT 的懒加载机制
  - 确保所有历史消息都被加载到 DOM 中

- **进度显示**：实时显示导出进度
  - 显示滚动加载进度："正在加载消息... (3/10)"
  - 显示消息提取进度："已提取 50/100 条消息..."
  - 显示导出阶段："生成 Markdown..."、"发送到 Kelivo..."

### 🐛 问题修复

- 修复长对话导出时消息遗漏的问题
- 修复 ChatGPT 懒加载导致的内容不完整问题

### 🔧 技术改进

- `extractConversation()` 改为异步函数，支持进度回调
- 新增 `ensureAllMessagesLoaded()` 函数自动加载所有消息
- 新增 `scrollToLoadAllMessages()` 和 `scrollToLoadAllMessagesFromBottom()` 辅助函数
- 改进 `showLoading()` 函数支持自定义消息

### 📝 使用说明

对于超长对话（100+ 条消息）：
1. 点击"导出到 Kelivo"按钮
2. 等待自动滚动和加载过程（可能需要 10-30 秒）
3. 观察按钮上的进度提示
4. 等待导出完成

## v1.0.0 - 初始版本

### ✨ 功能

- 一键导出 ChatGPT 对话
- 自动导入到 Kelivo 助手
- 智能提取对话标题
- 实时反馈通知

